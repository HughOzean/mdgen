<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>MD GEN</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="https://unpkg.com/turndown-plugin-gfm/dist/turndown-plugin-gfm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --border: #e2e8f0; }
        body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: var(--bg); }
        .card { background: white; border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .main-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 600px; }
        .panel { display: flex; flex-direction: column; background: white; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .panel-header { padding: 10px; background: #f1f5f9; font-weight: bold; border-bottom: 1px solid var(--border); }
        textarea { flex: 1; border: none; padding: 15px; font-family: 'Fira Code', monospace; outline: none; background: #fafafa; resize: none; font-size: 14px; }
        #preview { flex: 1; padding: 15px; overflow-y: auto; background: white; }
        .markdown-body table { border-collapse: collapse; width: 100%; margin-bottom: 1em; border: 1px solid #dfe2e5; }
        .markdown-body th, .markdown-body td { border: 1px solid #dfe2e5; padding: 6px 13px; }
        .markdown-body tr:nth-child(2n) { background: #f6f8fa; }
        button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; background: var(--primary); color: white; margin-right: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h1>Markdown 生成器</h1>
        <input type="file" id="fileInput" accept=".docx" />
        <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
            提示：支持从网页、Excel 或 Word 直接复制表格并粘贴到下方源码框。
        </p>
        <button onclick="downloadFile()">下载 Markdown</button>
        <button style="background: #64748b;" onclick="clearAll()">清空</button>
    </div>

    <div class="main-layout">
        <div class="panel">
            <div class="panel-header">Markdown 源码 (可直接粘贴表格)</div>
            <textarea id="output" placeholder="在此粘贴带表格的内容..."></textarea>
        </div>
        <div class="panel">
            <div class="panel-header">预览</div>
            <div id="preview" class="markdown-body"></div>
        </div>
    </div>

    <script>
        // 1. 初始化 Turndown 并加载 GFM 插件
        const turndownService = new TurndownService({ 
            headingStyle: 'atx', 
            bulletListMarker: '-',
            emDelimiter: '*' 
        });
        const gfm = turndownPluginGfm.gfm;
        turndownService.use(gfm);

        // 2. 移除标题内的加粗
        turndownService.addRule('remove-bold-in-headings', {
            filter: ['strong', 'b'],
            replacement: function (content, node) {
                const isInsideHeading = ['H1', 'H2', 'H3', 'H4'].includes(node.parentNode.nodeName);
                return isInsideHeading ? content : '**' + content + '**';
            }
        });

        const outputArea = document.getElementById('output');
        const previewArea = document.getElementById('preview');

        // 3. 核心：清洗粘贴的 HTML
        function cleanHTMLForTable(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // 1. 移除干扰标签
            doc.querySelectorAll('colgroup, col, style, meta, link, script').forEach(el => el.remove());

            // 2. 深度清洗：移除所有属性 + 解构 div
            doc.querySelectorAll('*').forEach(el => {
                if (el.tagName === 'DIV' || el.tagName === 'SPAN') {
                    const parent = el.parentNode;
                    while (el.firstChild) parent.insertBefore(el.firstChild, el);
                    el.remove();
                } else {
                    // 移除所有属性(class, style, data-...)，确保 Turndown 识别纯净标签
                    while (el.attributes.length > 0) el.removeAttribute(el.attributes[0].name);
                }
            });

            // 3. 【关键修复】强制转换第一行为表头
            // Markdown 表格必须有表头才能转换成功
            doc.querySelectorAll('table').forEach(table => {
                const firstRow = table.querySelector('tr');
                if (firstRow) {
                    const cells = firstRow.querySelectorAll('td');
                    cells.forEach(td => {
                        const th = doc.createElement('th');
                        th.innerHTML = td.innerHTML;
                        td.parentNode.replaceChild(th, td);
                    });
                }
                
                // 确保有 thead，如果没有，把第一行包裹进去
                if (!table.querySelector('thead') && firstRow) {
                    const thead = doc.createElement('thead');
                    thead.appendChild(firstRow);
                    table.insertBefore(thead, table.firstChild);
                }
            });

            return doc.body.innerHTML;
        }

        // 4. 处理粘贴事件
        outputArea.addEventListener('paste', function(e) {
            const html = e.clipboardData.getData('text/html');
            
            if (html) {
                e.preventDefault();
                
                // 进行预清洗
                const cleanedHTML = cleanHTMLForTable(html);
                
                // 转换
                let markdown = turndownService.turndown(cleanedHTML);
                
                // 插入内容
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + markdown + this.value.substring(end);
                
                previewArea.innerHTML = marked.parse(this.value);
            }
        });

        // 5. 其它逻辑 (Docx 上传)
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const options = {
                    transformDocument: (element) => {
                        if (element.children) element.children.forEach(c => {
                            if (c.type === "paragraph" && c.children[0]?.fontSize) {
                                const s = parseFloat(c.children[0].fontSize);
                                if (s >= 25 && s <= 27) c.styleName = "Heading1";
                                else if (s >= 15 && s <= 17) c.styleName = "Heading2";
                            }
                        });
                        return element;
                    }
                };
                try {
                    const result = await mammoth.convertToHtml({arrayBuffer: event.target.result}, options);
                    const markdown = turndownService.turndown(result.value);
                    outputArea.value = markdown;
                    previewArea.innerHTML = marked.parse(markdown);
                } catch (err) { alert("解析失败"); }
            };
            reader.readAsArrayBuffer(file);
        });

        outputArea.addEventListener('input', () => {
            previewArea.innerHTML = marked.parse(outputArea.value);
        });

        function downloadFile() {
            const blob = new Blob([outputArea.value], {type: 'text/markdown'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `convert_${Date.now()}.md`;
            a.click();
        }

        function clearAll() {
            outputArea.value = '';
            previewArea.innerHTML = '';
        }
    </script>
</body>
</html>
