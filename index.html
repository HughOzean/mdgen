<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Markdown Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="https://unpkg.com/turndown-plugin-gfm/dist/turndown-plugin-gfm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --border: #e2e8f0; }
        body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: var(--bg); }
        .card { background: white; border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .main-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 600px; }
        .panel { display: flex; flex-direction: column; background: white; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .panel-header { padding: 10px; background: #f1f5f9; font-weight: bold; border-bottom: 1px solid var(--border); }
        textarea { flex: 1; border: none; padding: 15px; font-family: 'Fira Code', monospace; outline: none; background: #fafafa; resize: none; font-size: 14px; }
        #preview { flex: 1; padding: 15px; overflow-y: auto; background: white; }
        .markdown-body table { border-collapse: collapse; width: 100%; margin-bottom: 1em; border: 1px solid #dfe2e5; }
        .markdown-body th, .markdown-body td { border: 1px solid #dfe2e5; padding: 6px 13px; }
        .markdown-body tr:nth-child(2n) { background: #f6f8fa; }
        .markdown-body img {max-height: 50vh;}
        .markdown-body blockquote {color:#999;border-left: 5px solid #CCC;padding-left: 1em;margin-inline-start:0;}
        button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; background: var(--primary); color: white; margin-right: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>Markdown 生成器</h2>
        <input type="file" id="fileInput" accept=".docx" />
        <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
            提示：支持从网页、Excel 或 Word 直接复制表格并粘贴到下方源码框。
        </p>
        <button onclick="downloadFile()">下载 Markdown</button>
        <button style="background: #64748b;" onclick="clearAll()">清空</button>
    </div>

    <div class="main-layout">
        <div class="panel">
            <div class="panel-header">Markdown 源码 (可直接粘贴表格)</div>
            <textarea id="output" placeholder="在此粘贴带表格的内容..."></textarea>
        </div>
        <div class="panel">
            <div class="panel-header">预览</div>
            <div id="preview" class="markdown-body"></div>
        </div>
    </div>

    <script>
        // 1. 初始化 Turndown 并加载 GFM 插件
        const turndownService = new TurndownService({ 
            headingStyle: 'atx', 
            bulletListMarker: '-',
            emDelimiter: '*' 
        });
        const gfm = turndownPluginGfm.gfm;
        turndownService.use(gfm);

        // 2. 移除标题内的加粗
        turndownService.addRule('remove-bold-in-headings', {
            filter: ['strong', 'b'],
            replacement: function (content, node) {
                const isInsideHeading = ['H1', 'H2', 'H3', 'H4'].includes(node.parentNode.nodeName);
                return isInsideHeading ? content : '**' + content + '**';
            }
        });

        const outputArea = document.getElementById('output');
        const previewArea = document.getElementById('preview');

        // 3. 核心：清洗粘贴的 HTML
        function cleanHTMLForTable(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // 1. 核心改进：处理 td 内部的换行与 div
            const cells = doc.querySelectorAll('td, th');
            cells.forEach(cell => {
                // 获取单元格内所有的文本内容，并将换行符替换为空格
                // 使用 innerText 可以获取感知上的换行，然后用正则处理
                let textContent = cell.innerText.replace(/[\n\r]+/g, ' ').trim();
                
                // 如果单元格里有图片，我们需要保留图片标签，只处理文本
                if (cell.querySelector('img')) {
                    // 对于含有图片的复杂单元格，我们单独解构 div 并处理换行
                    const divs = cell.querySelectorAll('div, span, p');
                    divs.forEach(d => {
                        const space = doc.createTextNode(' '); 
                        d.parentNode.insertBefore(space, d.nextSibling); // 在 div 后加空格
                        const parent = d.parentNode;
                        while (d.firstChild) parent.insertBefore(d.firstChild, d);
                        d.remove();
                    });
                } else {
                    // 纯文本单元格，直接替换为清洗后的文字
                    cell.innerHTML = textContent;
                }
            });

            // 2. 移除所有剩余属性（保留 img 的 src）
            doc.querySelectorAll('*').forEach(el => {
                const attrs = Array.from(el.attributes);
                attrs.forEach(attr => {
                    if (!(el.tagName === 'IMG' && attr.name === 'src')) {
                        el.removeAttribute(attr.name);
                    }
                });
            });

            // 3. 强制转换第一行为表头并构造 thead
            const firstRow = doc.querySelector('tr');
            if (firstRow) {
                firstRow.querySelectorAll('td').forEach(td => {
                    const th = doc.createElement('th');
                    th.innerHTML = td.innerHTML;
                    td.parentNode.replaceChild(th, td);
                });
                const thead = doc.createElement('thead');
                thead.appendChild(firstRow);
                doc.querySelector('table').insertBefore(thead, doc.querySelector('tbody'));
            }

            return doc.body.innerHTML;
        }

        // 4. 处理粘贴事件
        outputArea.addEventListener('paste', function(e) {
            const html = e.clipboardData.getData('text/html');
            
            if (html) {
                e.preventDefault();
                
                // 进行预清洗
                const cleanedHTML = cleanHTMLForTable(html);
                
                // 转换
                let markdown = turndownService.turndown(cleanedHTML);
                
                // 插入内容
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + markdown + this.value.substring(end);
                
                previewArea.innerHTML = marked.parse(this.value);
            }
        });

        // 5. 其它逻辑 (Docx 上传)
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const options = {
                    transformDocument: (element) => {
                        if (element.children) element.children.forEach(c => {
                            if (c.type === "paragraph" && c.children[0]?.fontSize) {
                                const s = parseFloat(c.children[0].fontSize);
                                if (s >= 25 && s <= 27) c.styleName = "Heading1";
                                else if (s >= 15 && s <= 17) c.styleName = "Heading2";
                            }
                        });
                        return element;
                    }
                };
                try {
                    const result = await mammoth.convertToHtml({arrayBuffer: event.target.result}, options);
                    const markdown = turndownService.turndown(result.value);
                    outputArea.value = markdown;
                    previewArea.innerHTML = marked.parse(markdown);
                } catch (err) { alert("解析失败"); }
            };
            reader.readAsArrayBuffer(file);
        });

        outputArea.addEventListener('input', () => {
            previewArea.innerHTML = marked.parse(outputArea.value);
        });

        function downloadFile() {
            const blob = new Blob([outputArea.value], {type: 'text/markdown'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `convert_${Date.now()}.md`;
            a.click();
        }

        function clearAll() {
            outputArea.value = '';
            previewArea.innerHTML = '';
        }
    </script>
</body>
</html>
