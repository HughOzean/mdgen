<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Markdown Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="https://unpkg.com/turndown-plugin-gfm/dist/turndown-plugin-gfm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --border: #e2e8f0; }
        body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: var(--bg); }
        .card { background: white; border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .main-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 600px; }
        .panel { display: flex; flex-direction: column; background: white; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .panel-header { padding: 10px; background: #f1f5f9; font-weight: bold; border-bottom: 1px solid var(--border); }
        textarea { flex: 1; border: none; padding: 15px; font-family: 'Fira Code', monospace; outline: none; background: #fafafa; resize: none; font-size: 14px; }
        #preview { flex: 1; padding: 15px; overflow-y: auto; background: white; }
        .markdown-body table { border-collapse: collapse; width: 100%; margin-bottom: 1em; border: 1px solid #dfe2e5; }
        .markdown-body th, .markdown-body td { border: 1px solid #dfe2e5; padding: 6px 13px; }
        .markdown-body tr:nth-child(2n) { background: #f6f8fa; }
        .markdown-body blockquote {color:#999;border-left: 5px solid #CCC;padding-left: 1em;margin-inline-start:0;}
        button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; background: var(--primary); color: white; margin-right: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>Markdown ç”Ÿæˆå™¨</h2>
        <input type="file" id="fileInput" accept=".docx" />
        <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
            æç¤ºï¼šæ”¯æŒä»ç½‘é¡µã€Excel æˆ– Word ç›´æ¥å¤åˆ¶è¡¨æ ¼å¹¶ç²˜è´´åˆ°ä¸‹æ–¹æºç æ¡†ã€‚
        </p>
        <button onclick="downloadFile()">ä¸‹è½½ Markdown</button>
        <button style="background: #64748b;" onclick="clearAll()">æ¸…ç©º</button>
    </div>

    <div class="main-layout">
        <div class="panel">
            <div class="panel-header">Markdown æºç  (å¯ç›´æ¥ç²˜è´´è¡¨æ ¼)</div>
            <textarea id="output" placeholder="åœ¨æ­¤ç²˜è´´å¸¦è¡¨æ ¼çš„å†…å®¹..."></textarea>
        </div>
        <div class="panel">
            <div class="panel-header">é¢„è§ˆ</div>
            <div id="preview" class="markdown-body"></div>
        </div>
    </div>

    <script>
        // 1. åˆå§‹åŒ– Turndown å¹¶åŠ è½½ GFM æ’ä»¶
        const turndownService = new TurndownService({ 
            headingStyle: 'atx', 
            bulletListMarker: '-',
            emDelimiter: '*' 
        });
        const gfm = turndownPluginGfm.gfm;
        turndownService.use(gfm);

        // 2. ç§»é™¤æ ‡é¢˜å†…çš„åŠ ç²—
        turndownService.addRule('remove-bold-in-headings', {
            filter: ['strong', 'b'],
            replacement: function (content, node) {
                const isInsideHeading = ['H1', 'H2', 'H3', 'H4'].includes(node.parentNode.nodeName);
                return isInsideHeading ? content : '**' + content + '**';
            }
        });

        const outputArea = document.getElementById('output');
        const previewArea = document.getElementById('preview');

        // 3. æ ¸å¿ƒï¼šæ¸…æ´—ç²˜è´´çš„ HTML
        function cleanHTMLForTable(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // 1. å…ˆå¤„ç†å†…å®¹ï¼šè§£æ„ td/th å†…éƒ¨çš„ div/spanï¼Œä½†ä¿ç•™å…¶å­èŠ‚ç‚¹ï¼ˆå¦‚ imgï¼‰
            const contents = doc.querySelectorAll('td div, td span, th div, th span');
            contents.forEach(el => {
                const parent = el.parentNode;
                while (el.firstChild) {
                    parent.insertBefore(el.firstChild, el);
                }
                el.remove();
            });

            // 2. ç²¾ç»†æ¸…æ´—å±æ€§ï¼šé™¤äº† img çš„ srcï¼Œå…¶ä½™å…¨éƒ¨åˆ é™¤
            const allElements = doc.querySelectorAll('*');
            allElements.forEach(el => {
                const attributes = Array.from(el.attributes);
                attributes.forEach(attr => {
                    // ğŸ’¡ å…³é”®ç‚¹ï¼šå¦‚æœæ˜¯ img æ ‡ç­¾ä¸”å±æ€§æ˜¯ srcï¼Œåˆ™ä¿ç•™ï¼›å¦åˆ™ç§»é™¤
                    if (!(el.tagName === 'IMG' && attr.name === 'src')) {
                        el.removeAttribute(attr.name);
                    }
                });
            });

            // 3. å¼ºåˆ¶è½¬æ¢ç¬¬ä¸€è¡Œä¸ºè¡¨å¤´ï¼ˆç¡®ä¿ Turndown è¯†åˆ«è¡¨æ ¼ï¼‰
            const firstRow = doc.querySelector('tr');
            if (firstRow) {
                firstRow.querySelectorAll('td').forEach(td => {
                    const th = doc.createElement('th');
                    th.innerHTML = td.innerHTML;
                    td.parentNode.replaceChild(th, td);
                });
            }

            // 4. æ¸…ç†å¹²æ‰°æ ‡ç­¾
            doc.querySelectorAll('colgroup, col, style, meta').forEach(el => el.remove());

            return doc.body.innerHTML;
        }

        // 4. å¤„ç†ç²˜è´´äº‹ä»¶
        outputArea.addEventListener('paste', function(e) {
            const html = e.clipboardData.getData('text/html');
            
            if (html) {
                e.preventDefault();
                
                // è¿›è¡Œé¢„æ¸…æ´—
                const cleanedHTML = cleanHTMLForTable(html);
                
                // è½¬æ¢
                let markdown = turndownService.turndown(cleanedHTML);
                
                // æ’å…¥å†…å®¹
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + markdown + this.value.substring(end);
                
                previewArea.innerHTML = marked.parse(this.value);
            }
        });

        // 5. å…¶å®ƒé€»è¾‘ (Docx ä¸Šä¼ )
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const options = {
                    transformDocument: (element) => {
                        if (element.children) element.children.forEach(c => {
                            if (c.type === "paragraph" && c.children[0]?.fontSize) {
                                const s = parseFloat(c.children[0].fontSize);
                                if (s >= 25 && s <= 27) c.styleName = "Heading1";
                                else if (s >= 15 && s <= 17) c.styleName = "Heading2";
                            }
                        });
                        return element;
                    }
                };
                try {
                    const result = await mammoth.convertToHtml({arrayBuffer: event.target.result}, options);
                    const markdown = turndownService.turndown(result.value);
                    outputArea.value = markdown;
                    previewArea.innerHTML = marked.parse(markdown);
                } catch (err) { alert("è§£æå¤±è´¥"); }
            };
            reader.readAsArrayBuffer(file);
        });

        outputArea.addEventListener('input', () => {
            previewArea.innerHTML = marked.parse(outputArea.value);
        });

        function downloadFile() {
            const blob = new Blob([outputArea.value], {type: 'text/markdown'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `convert_${Date.now()}.md`;
            a.click();
        }

        function clearAll() {
            outputArea.value = '';
            previewArea.innerHTML = '';
        }
    </script>
</body>
</html>
